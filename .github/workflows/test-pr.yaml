name: "CI - Test Templates"
on:
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ludeeus/action-shellcheck@2.0.0
        with:
          check_together: 'yes'
        env:
          SHELLCHECK_OPTS: -e SC1090 -e SC1091

  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.output.outputs.apps }}
    steps:
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          list-files: json
        # BENCH-4080: Re-enable cirrocumulus test
          filters: |
            common: &common
              - '.github/workflows/test-pr.yaml'
              - '.github/actions/smoke-test/**'
              - 'startupscript/**'
              - 'test/**'
              - 'features/src/workbench-tools/**'
            jupyter-template:
              - *common
              - './src/jupyter-template/**'
            jupyter:
              - *common
              - './src/jupyter/**'
            shiny:
              - *common
              - './src/shiny/**'
            r-analysis:
              - *common
              - './src/r-analysis/**'
            vscode:
              - *common
              - './src/vscode/**'
            jupyter-aou:
              - *common
              - './src/jupyter-aou/**'
            nemo_jupyter:
              - *common
              - './src/nemo_jupyter/**'
            nemo_jupyter_aou:
              - *common
              - './src/nemo_jupyter_aou/**'
            workbench-jupyter-parabricks:
              - *common
              - './src/workbench-jupyter-parabricks/**'
            workbench-jupyter-parabricks-aou:
              - *common
              - './src/workbench-jupyter-parabricks-aou/**'
      - name: Output changed templates as JSON object
        id: output
        run: |
          MAXIMIZE_BUILD_SPACE='["jupyter-aou", "nemo_jupyter", "nemo_jupyter_aou"]'
          CHANGED_TEMPLATES='${{ steps.filter.outputs.changes }}'

          # output to github output
          echo "apps<<EOF" >> $GITHUB_OUTPUT
          jq -n \
              --argjson changed "$CHANGED_TEMPLATES" \
              --argjson maximize "$MAXIMIZE_BUILD_SPACE" \
              '[$changed[] as $t | select($t != "common") | { template: $t, maximize_build_space: $maximize | (index($t) != null) }]' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT


  test:
    name: "Smoke test '${{ matrix.app.template }}'"
    needs: [detect-changes]
    runs-on: ubuntu-latest
    continue-on-error: true
    if : ${{ needs.detect-changes.outputs.templates != '[]' }}
    strategy:
      matrix:
        app: ${{ fromJSON(needs.detect-changes.outputs.apps) }}
    steps:
      - uses: actions/checkout@v4

      # Free up disk space by removing unnecessary files, if needed
      - name: Maximize build disk space
        if: ${{ matrix.app.maximize_build_space }}
        uses: easimon/maximize-build-space@v10
        with:
          # This is the amount of space left over, not allocated to the LVM
          # volume. We already checked out the repo so we don't need much
          root-reserve-mb: 512
          build-mount-path: /var/lib/docker
          remove-dotnet: true
          remove-android: true
          remove-haskell: true
          remove-codeql: true
          remove-docker-images: true

      - name: Restart docker
        if: ${{ matrix.app.maximize_build_space }}
        run: sudo service docker restart

      - name: Smoke test for '${{ matrix.app.template }}'
        id: smoke_test
        uses: ./.github/actions/smoke-test
        with:
          template: "${{ matrix.app.template }}"
